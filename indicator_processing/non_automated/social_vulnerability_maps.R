# Code to attempt plotting the social vulnerability data as maps

# First download shapefiles

# Puerto Rico

library(sf)
library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)

us_shapefile <- st_read("../../../Downloads/tl_2020_us_county/tl_2020_us_county.shp")

pr_shapefile = us_shapefile %>% 
  filter(STATEFP == "72")

#Rename the name column to Community

pr_shapefile = pr_shapefile %>% 
  rename(Community = NAME)


#Read in CSVI data
CSVI_2010 = read_csv("indicator_data/inputsToBeUpdatedAnnually/CaribCSVI_2010.csv", locale = locale(encoding = "UTF-8"))
CSVI_2020 = read_csv("indicator_data/inputsToBeUpdatedAnnually/CaribCSVI_2020.csv", locale = locale(encoding = "UTF-8"))



CSVI_2010$Year <- 2010
CSVI_2020$Year <- 2020

#remove columns for raw data
CSVI_2010 = CSVI_2010[,-c(2:7)]
CSVI_2020 = CSVI_2020[,-c(2:7)]

library(dplyr)
library(tidyr)



# Reshape the 2010 and 2020 data to wide format
CSVI_combined <- bind_rows(CSVI_2010, CSVI_2020) %>%
  pivot_wider(names_from = Year, values_from = c(PerDisCat, PopComCat, PovertyCat, 
                                                 LabFrc_revCat, HsChr_rev_Cat, RetMigCat)) %>%
  mutate(PerDisCat_diff = `PerDisCat_2020` - `PerDisCat_2010`,
         PopComCat_diff = `PopComCat_2020` - `PopComCat_2010`,
         PovertyCat_diff = `PovertyCat_2020` - `PovertyCat_2010`,
         LabFrc_revCat_diff = `LabFrc_revCat_2020` - `LabFrc_revCat_2010`,
         HsChr_rev_Cat_diff = `HsChr_rev_Cat_2020` - `HsChr_rev_Cat_2010`,
         RetMigCat_diff = `RetMigCat_2020` - `RetMigCat_2010`)

# View the updated data
head(CSVI_combined)

# remove rows 3-14 and 20
CSVI_combined = CSVI_combined[,-c(3:14,20)]


# Combine both dataframes
df_combined <- left_join(CSVI_2010, CSVI_2020, by="Community")




# Convert to long format for ggplot
df_long <- df_combined %>%
  pivot_longer(cols = ends_with("Cat"),
               names_to = "Indicator",
               values_to = "Score")

# Remove rows with NA values
df_long <- na.omit(df_long)

df_long$Community = as.character(df_long$Community)
df_long$Region = as.character(df_long$Region)
df_long$Year = as.factor(df_long$Year)
df_long$Indicator = as.character(df_long$Indicator)
df_long$Score = as.integer(df_long$Score)



# Rename and combine regions
df_long <- df_long %>%
  mutate(Region = recode(Region,
                         'STT' = 'USVI',
                         'STJ' = 'USVI',
                         'STX' = 'USVI',
                         'W' = 'Puerto Rico',
                         'E' = 'Puerto Rico'))

# Verify the changes
unique(df_long$Region)


# Rename indicators
df_long <- df_long %>%
  mutate(Indicator = recode(Indicator,
                            'PerDisCat' = 'Personal Disruption',
                            'PopComCat' = 'Pop Composition',
                            'PovertyCat' = 'Poverty',
                            'LabFrc_revCat' = 'Labor Force',
                            'HsChr_rev_Cat' = 'Housing Charac',
                            'RetMigCat' = 'Retiree Migration'))

unique(df_long$Indicator)



# merge shapefile with CSVI data

map_dat = right_join(df_long, pr_shapefile, by = "Community")



#remove USVI for now

PRmap_dat <- map_dat %>%
  mutate(Region = ifelse(is.na(Region), "Puerto Rico", Region))


head(PRmap_dat)

# Make a heatmap


st_geometry_type(PRmap_dat)
PRmap_dat <- st_as_sf(PRmap_dat)


# Filter for a specific year and indicator
filtered_data <- PRmap_dat %>%
  filter(Year == 2020 | is.na(Year), Indicator == "Personal Disruption" | is.na(Indicator))

# Plot
ggplot(filtered_data) +
  geom_sf(aes(fill = Score), color = "black", size = 0.2) +
  scale_fill_gradientn(colors = c("blue", "yellow", "red"), 
                       limits = c(0, 4), 
                       breaks = 0:4,
                       na.value = "white",
                       name = "Vulnerability Score") +
  theme_minimal() +
  labs(title = "Social Vulnerability: Personal Disruption (2020)",
       subtitle = "Puerto Rico",
       caption = "Source: Your Data")



