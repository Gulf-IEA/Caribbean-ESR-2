# Code to plot the social vulnerability data as maps

rm(list = ls())

plot.new()
dev.off()

############ First download shape files

library(sf)
library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)
library(grid)

pr_shapefile <- st_read("../../../Downloads/kx-puerto-rico-municipality-boundaries-SHP/puerto-rico-municipality-boundaries.shp")

vi_shapefile <- st_read("../../../Downloads/tl_2023_78_cousub/tl_2023_78_cousub.shp")

#Rename the name column to Community
pr_shapefile = pr_shapefile %>% 
  rename(Community = NOMBRE)

vi_shapefile = vi_shapefile %>% 
  rename(Community = NAME)


# remove some weird rows in the vi file
vi_shapefile = vi_shapefile %>% 
  filter(Community != "Island subdivision not defined")

# There are three East Ends, need to re-name them
vi_shapefile = vi_shapefile %>% 
  mutate(Community = ifelse(Community == "East End" & COUNTYFP == "010", "East End STX",
                            ifelse(Community == "East End" & COUNTYFP == "020", "East End STJ",
                                   ifelse(Community == "East End" & COUNTYFP == "030", "East End STT",
                                          Community))))


################## Read in CSVI data

CSVI_2010 = read_csv("indicator_data/inputsToBeUpdatedAnnually/CaribCSVI_2010.csv", locale = locale(encoding = "UTF-8"))
CSVI_2020 = read_csv("indicator_data/inputsToBeUpdatedAnnually/CaribCSVI_2020.csv", locale = locale(encoding = "UTF-8"))


CSVI_2010$Year <- 2010
CSVI_2020$Year <- 2020

# Combine both dataframes
df_combined <- bind_rows(CSVI_2010, CSVI_2020)


#remove columns for raw data
df_combined = df_combined[,-c(2:7)]

# Convert to long format for ggplot
df_long <- df_combined %>%
  pivot_longer(cols = ends_with("Cat"),
               names_to = "Indicator",
               values_to = "Score")

# Remove rows with NA values
df_long <- na.omit(df_long)

df_long$Community = as.character(df_long$Community)
df_long$Region = as.character(df_long$Region)
df_long$Year = as.factor(df_long$Year)
df_long$Indicator = as.character(df_long$Indicator)
df_long$Score = as.integer(df_long$Score)

# Rename and combine regions
df_long <- df_long %>%
  mutate(Region = recode(Region,
                         'STT' = 'STT',
                         'STJ' = 'STJ',
                         'STX' = 'STX',
                         'W' = 'Puerto Rico',
                         'E' = 'Puerto Rico'))

# Verify the changes
unique(df_long$Region)

# Rename indicators
df_long <- df_long %>%
  mutate(Indicator = recode(Indicator,
                            'PerDisCat' = 'Personal Disruption',
                            'PopComCat' = 'Pop Composition',
                            'PovertyCat' = 'Poverty',
                            'LabFrc_revCat' = 'Labor Force',
                            'HsChr_rev_Cat' = 'Housing Charac',
                            'RetMigCat' = 'Retiree Migration'))

unique(df_long$Indicator)

# There are two East Ends, one in STX and one in STT. Need to rename them
df_long = df_long %>% 
  mutate(Community = ifelse(Community == "East End" & Region == "STX", "East End STX",
                            ifelse(Community == "East End" & Region == "STT", "East End STT",
                                   Community)))


############### merge shapefiles with CSVI data

pr_map_dat = right_join(df_long, pr_shapefile, by = "Community")
vi_map_dat = right_join(df_long, vi_shapefile, by = "Community")

head(pr_map_dat)
head(vi_map_dat)


# Need to fill out rows for communities with no data and add NAs for the score variable

# Define all possible values for Year and Indicator
years <- as.factor(c(2010, 2020))
indicators <- c("Personal Disruption", "Pop Composition", "Poverty", 
                "Labor Force", "Housing Charac", "Retiree Migration")

# Extract geometry column separately
community_geometry_pr <- pr_map_dat %>%
  select(Community, geometry) %>%
  distinct()

community_geometry_vi <- vi_map_dat %>%
  select(Community, geometry) %>%
  distinct()

# Create a grid of all combinations
all_combinations_pr <- expand.grid(
  Community = unique(pr_map_dat$Community), 
  Year = years,
  Indicator = indicators
)

all_combinations_vi <- expand.grid(
  Community = unique(vi_map_dat$Community), 
  Year = years,
  Indicator = indicators
)

# Add rows for all combinations to pr_map_dat
pr_map_dat_complete <- all_combinations_pr %>%
  left_join(community_geometry_pr, by = "Community") %>% # Add geometry
  left_join(pr_map_dat, by = c("Community", "Year", "Indicator", "geometry")) # Merge with original data

vi_map_dat_complete <- all_combinations_vi %>%
  left_join(community_geometry_vi, by = "Community") %>% # Add geometry
  left_join(vi_map_dat, by = c("Community", "Year", "Indicator", "geometry")) # Merge with original data

# Replace missing `Score` with NA
pr_map_dat_complete <- pr_map_dat_complete %>%
  mutate(Score = ifelse(is.na(Score), NA, Score))

vi_map_dat_complete <- vi_map_dat_complete %>%
  mutate(Score = ifelse(is.na(Score), NA, Score))



######################### Make the plots!

#change dataframe to sf

pr_map_dat_complete <- st_as_sf(pr_map_dat_complete)
st_geometry_type(pr_map_dat_complete)

vi_map_dat_complete <- st_as_sf(vi_map_dat_complete)
st_geometry_type(vi_map_dat_complete)




# Prepare data for facet wrapping
facet_data_pr <- pr_map_dat_complete %>%
  filter(Year %in% c(2010, 2020)) %>%
  mutate(
    Year = as.factor(Year),  # Ensure Year is treated as a factor for faceting
    Indicator = factor(Indicator, levels = c(
      "Personal Disruption", "Pop Composition", "Poverty", "Labor Force", "Housing Charac", 
      "Retiree Migration" 
    ))
  )

# Plot with facets
p1 = ggplot(facet_data_pr) +
  geom_sf(aes(fill = Score), color = "black", size = 0.2) +
  scale_fill_gradientn(colors = c("blue", "yellow", "red"), 
                       limits = c(0, 4), 
                       breaks = 0:4,
                       na.value = "white",
                       name = "Vulnerability Score") +
  theme_minimal() +
  labs(title = "Social Vulnerability across Indicators and Years",
       subtitle = "Puerto Rico",
       caption = "White fill denotes no data") +
  facet_grid(Indicator ~ Year, switch = "y") +
  theme(
    strip.text.y = element_text(size = 10, angle = 0),
    strip.text.x = element_text(size = 10),
    panel.spacing = unit(0.5, "lines"),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),  # White panel background
    plot.background = element_rect(fill = "white", color = NA)    # White plot background
  )

ggsave("indicator_plots/CSVI_plots/PR_vulnerability.png", plot = p1, width = 12, height = 10)




# Prepare data for facet wrapping
facet_data_vi <- vi_map_dat_complete %>%
  filter(Year %in% c(2010, 2020)) %>%
  mutate(
    Year = as.factor(Year),  # Ensure Year is treated as a factor for faceting
    Indicator = factor(Indicator, levels = c(
      "Personal Disruption", "Pop Composition", "Poverty", "Labor Force", "Housing Charac", 
      "Retiree Migration" 
    ))
  )

# Plot with facets
p2 = ggplot(facet_data_vi) +
  geom_sf(aes(fill = Score), color = "black", size = 0.2) +
  scale_fill_gradientn(colors = c("blue", "yellow", "red"), 
                       limits = c(0, 4), 
                       breaks = 0:4,
                       na.value = "white",
                       name = "Vulnerability Score") +
  theme_minimal() +
  labs(title = "Social Vulnerability across Indicators and Years",
       subtitle = "U.S. Virgin Islands",
       caption = "White fill denotes no data") +
  facet_grid(Indicator ~ Year, switch = "y") +
  theme(
    strip.text.y = element_text(size = 10, angle = 0),
    strip.text.x = element_text(size = 10),
    panel.spacing = unit(0.5, "lines"),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),  # White panel background
    plot.background = element_rect(fill = "white", color = NA)    # White plot background
  )

ggsave("indicator_plots/CSVI_plots/USVI_vulnerability.png", plot = p2, width = 6, height = 10)














































#remove columns for raw data
CSVI_2010 = CSVI_2010[,-c(2:7)]
CSVI_2020 = CSVI_2020[,-c(2:7)]

# Reshape the 2010 and 2020 data to wide format
CSVI_combined <- bind_rows(CSVI_2010, CSVI_2020) %>%
  pivot_wider(names_from = Year, values_from = c(PerDisCat, PopComCat, PovertyCat, 
                                                 LabFrc_revCat, HsChr_rev_Cat, RetMigCat)) %>%
  mutate(PerDisCat_diff = `PerDisCat_2020` - `PerDisCat_2010`,
         PopComCat_diff = `PopComCat_2020` - `PopComCat_2010`,
         PovertyCat_diff = `PovertyCat_2020` - `PovertyCat_2010`,
         LabFrc_revCat_diff = `LabFrc_revCat_2020` - `LabFrc_revCat_2010`,
         HsChr_rev_Cat_diff = `HsChr_rev_Cat_2020` - `HsChr_rev_Cat_2010`,
         RetMigCat_diff = `RetMigCat_2020` - `RetMigCat_2010`)

# View the updated data
head(CSVI_combined)

# remove rows 3-14 and 20
CSVI_combined = CSVI_combined[,-c(3:14,20)]

